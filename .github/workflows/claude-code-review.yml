name: Claude PR Review

on:
  issue_comment:
    types: [created]

jobs:
  claude-code-action:
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/claude-review') &&
      contains(fromJson('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)

    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v8
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('number', pr.data.number);
            core.setOutput('ref', pr.data.head.ref);
            core.setOutput('sha', pr.data.head.sha);
            core.setOutput('base_ref', pr.data.base.ref);

      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.pr.outputs.sha }}
          fetch-depth: 0

      - name: Add reaction
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Run Claude PR Action
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ORG_ANTHROPIC_API_KEY }}
          track_progress: true
          use_sticky_comment: true

          # the following line is excluded from the prompt because the comments are given as a global context
          # see: https://github.com/anthropics/claude-code-action/blob/108e9829000952e342fefd85a76436e7a1dd1058/src/create-prompt/index.ts#L520
          # `To see more details about the PR, you can use `gh pr view` but should *without* `--comments` to avoid redundant information.`
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ steps.pr.outputs.number }}

            ultrathink: ì‹¬ì‚¬ìˆ™ê³ í•´ì„œ ë¦¬ë·°ë¥¼ ì§„í–‰í•˜ì„¸ìš”.

            Please review this pull request, **in Korean (í•œêµ­ì–´)**, with a focus on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations

            <thoughtful-pr-review>
            ì´ Pull Requestë¥¼ ì›ì¹™ ê¸°ë°˜ìœ¼ë¡œ ì‹¬ì‚¬ìˆ™ê³ í•˜ì—¬ ë¦¬ë·°í•´ì£¼ì„¸ìš”.

            <pr-info>
            - GITHUB OWNER: ${{ github.repository_owner }}
            - PR_NUMBER: ${{ steps.pr.outputs.number }}
            - TARGET_REF: ${{ steps.pr.outputs.base_ref }}
            </pr-info>

            <review-philosophy>
            ë‹¹ì‹ ì€ ì´ í”„ë¡œì íŠ¸ë¥¼ í•¨ê»˜ ë§Œë“¤ì–´ê°€ëŠ” ë™ë£Œì…ë‹ˆë‹¤.
            ë¹„í‰ê°€ê°€ ì•„ë‹Œ í˜‘ë ¥ìë¡œì„œ, ì‚¬ìš©ìì˜ ì˜ë„ë¥¼ ì¡´ì¤‘í•˜ë©°
            ì •ë§ í•„ìš”í•œ í”¼ë“œë°±ë§Œ ì œê³µí•©ë‹ˆë‹¤.
            </review-philosophy>

            <step-1-deep-understanding>
            ë¨¼ì € ë‹¤ìŒì„ í†µí•´ ì™„ì „íˆ ì´í•´í•˜ì„¸ìš”:
            1. AGENTS.md ì „ì²´ ì½ê¸° - íŠ¹íˆ "PR Review Guidelines" ì„¹ì…˜ ìˆ™ì§€
            2. PR ì œëª©ê³¼ ì„¤ëª… - ì‚¬ìš©ìì˜ ì˜ë„ì™€ ëª©ì  íŒŒì•…
            3. ë³€ê²½ íŒŒì¼ë“¤ì˜ ì „ì²´ ê·¸ë¦¼ - ë¬´ì—‡ì„ í•˜ë ¤ëŠ”ì§€ ì´í•´
            4. git log --oneline -10 - ìµœê·¼ ê°œë°œ ë°©í–¥ê³¼ íŒ¨í„´ í™•ì¸
            5. ì´ì „ PR ì½”ë©˜íŠ¸ í™•ì¸ (`gh pr view ${{ steps.pr.outputs.number }} --comments`)
               - ì´ë¯¸ ë…¼ì˜ëœ ë‚´ìš© íŒŒì•…
               - ë¬´ì‹œëœ ì œì•ˆì€ ë‹¤ì‹œ ì œì•ˆí•˜ì§€ ì•Šê¸°
               - ì‚¬ìš©ìì˜ ì„ í˜¸ íŒ¨í„´ í•™ìŠµ
            </step-1-deep-understanding>

            <step-2-contextual-analysis>
            PRì˜ ì‹¤ì œ ë‚´ìš©ì„ ê¹Šì´ ë¶„ì„í•˜ì—¬ ìœ í˜• íŒŒì•…:

            <pr-type-detection>
            ë‹¤ìŒì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ PR ìœ í˜•ì„ íŒŒì•…í•˜ì„¸ìš”:
            - ë³€ê²½ íŒŒì¼ë“¤ì˜ ì„±ê²©: ì–´ë–¤ ì¢…ë¥˜ì˜ íŒŒì¼ë“¤ì´ ìˆ˜ì •ë˜ì—ˆëŠ”ê°€?
            - ì½”ë“œ ë³€ê²½ íŒ¨í„´: ì¶”ê°€/ì‚­ì œ/ìˆ˜ì •ì˜ ë¹„ìœ¨ê³¼ ë²”ìœ„
            - PR ì„¤ëª…ê³¼ ì—°ê²°ëœ ì´ìŠˆ: ì–´ë–¤ ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ëŠ”ê°€?
            - ì»¤ë°‹ ë©”ì‹œì§€ë“¤: ì‘ì—…ì˜ ì§„í–‰ ê³¼ì •ê³¼ ì˜ë„
            </pr-type-detection>

            <review-strategy-by-type>
            - ê¸´ê¸‰ ë²„ê·¸ ìˆ˜ì •: ë¬¸ì œ í•´ê²°ì— ì§‘ì¤‘, ìµœì†Œí•œì˜ ì§€ì ë§Œ
            - ì¼ë°˜ ë²„ê·¸ ìˆ˜ì •: ê·¼ë³¸ ì›ì¸ í•´ê²° í™•ì¸, ì¬ë°œ ë°©ì§€ ì²´í¬
            - ìƒˆ ê¸°ëŠ¥ ì¶”ê°€: ê¸°ëŠ¥ ì™„ì„±ë„, ì—£ì§€ì¼€ì´ìŠ¤, ì‚¬ìš©ì„±
            - ë¦¬íŒ©í† ë§: ë™ì‘ ë³€ê²½ ì—†ìŒ í™•ì¸, ì¼ê´€ì„± ê°œì„  ê²€ì¦
            - êµ¬ì¡° ë³€ê²½: ì˜í–¥ ë²”ìœ„ íŒŒì•…, í•˜ìœ„ í˜¸í™˜ì„± ì²´í¬
            - í›„ì† PR: ì´ì „ PRê³¼ì˜ ì—°ê²°ì„±, ì „ì²´ ê·¸ë¦¼ì—ì„œì˜ ìœ„ì¹˜
            - ì„±ëŠ¥ ê°œì„ : ì‹¤ì œ ê°œì„  ê²€ì¦, ë¶€ì‘ìš© í™•ì¸
            - ë¬¸ì„œ/ì„¤ì • ë³€ê²½: ì •í™•ì„±ê³¼ ì™„ì „ì„±ë§Œ ì²´í¬
            </review-strategy-by-type>
            </step-2-contextual-analysis>

            <step-3-thoughtful-judgment>
            ê° ë°œê²¬ì‚¬í•­ì— ëŒ€í•´ ìë¬¸:
            - "ì´ê²ƒì´ PRì˜ ì„±ê³µì„ ë§‰ëŠ”ê°€?"
            - "ì‚¬ìš©ìê°€ ì´ë¯¸ ì•Œê³  ìˆì„ ê°€ëŠ¥ì„±ì´ ìˆëŠ”ê°€?"
            - "ì§€ê¸ˆ ë‹¹ì¥ ìˆ˜ì •ì´ í•„ìš”í•œê°€?"
            - "ë‚´ ì œì•ˆì´ PR ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ëŠ”ê°€?"
            - "ì´ì „ì— ìœ ì‚¬í•œ ì œì•ˆì´ ê±°ì ˆëœ ì ì´ ìˆëŠ”ê°€?"
            </step-3-thoughtful-judgment>

            <step-4-inline-comments>
            <developer-intent-based-comments>
            ì¸ë¼ì¸ ì½”ë©˜íŠ¸ëŠ” ê°œë°œìì˜ ì˜ë„ì™€ PR ëª©ì ì— ì¶©ì‹¤í•´ì•¼ í•©ë‹ˆë‹¤:

            <pr-type-comment-focus>
            - ë²„ê·¸ ìˆ˜ì • PR â†’ ë²„ê·¸ í•´ê²°ê³¼ ì§ì ‘ ê´€ë ¨ëœ ì´ìŠˆë§Œ
            - ê¸°ëŠ¥ ì¶”ê°€ PR â†’ ìƒˆ ê¸°ëŠ¥ì˜ ì™„ì„±ë„ì™€ ì•ˆì •ì„±
            - ë¦¬íŒ©í† ë§ PR â†’ ì½”ë“œ í’ˆì§ˆê³¼ ì¼ê´€ì„± ê°œì„ 
            - ì„±ëŠ¥ ê°œì„  PR â†’ ì„±ëŠ¥ ìµœì í™”ì™€ ê´€ë ¨ëœ ë¶€ë¶„
            - ë¬¸ì„œ/ì„¤ì • PR â†’ ì •í™•ì„±ê³¼ ëª…í™•ì„±
            </pr-type-comment-focus>

            <when-to-comment>
            ë‹¤ìŒ ê²½ìš°ì—ë§Œ ì¸ë¼ì¸ ì½”ë©˜íŠ¸:
            â˜‘ PRì—ì„œ ìˆ˜ì •í•œ ë¶€ë¶„ê³¼ ì§ì ‘ ê´€ë ¨
            â˜‘ PR ëª©ì ì— ë¶€í•©í•˜ëŠ” í”¼ë“œë°±
            â˜‘ ê°„ë‹¨í•˜ê²Œ ìˆ˜ì • ê°€ëŠ¥í•œ ë²”ìœ„
            â˜‘ êµ¬ì²´ì ì¸ í•´ê²°ì±… ì œì‹œ ê°€ëŠ¥
            â˜‘ ê°œë°œìê°€ ë†“ì³¤ì„ ê°€ëŠ¥ì„±ì´ ìˆëŠ” ê²ƒ
            </when-to-comment>

            <comment-tone-and-format>
            - ë™ë£Œì˜ ê´€ì : "ì´ ë¶€ë¶„ì€ ~í•˜ë©´ ì–´ë–¨ê¹Œìš”?"
            - êµ¬ì²´ì  ì œì•ˆ: ê°€ëŠ¥í•˜ë©´ ì½”ë“œ ì˜ˆì‹œ í¬í•¨
            - ì´ìœ  ì„¤ëª…: ì™œ ì¤‘ìš”í•œì§€ ê°„ë‹¨íˆ
            - ìœ ì—°ì„± ë¶€ì—¬: "ê³ ë ¤í•´ë³´ì‹œë©´ ì¢‹ì„ ê²ƒ ê°™ì•„ìš”"
            </comment-tone-and-format>

            <focus-breakers-to-avoid>
            âŒ ë²„ê·¸ ìˆ˜ì • PRì— êµ¬ì¡° ë³€ê²½ ì œì•ˆ
            âŒ ê¸°ëŠ¥ ê°œì„  PRì— ëŒ€ê·œëª¨ ë¦¬íŒ©í† ë§ ì œì•ˆ
            âŒ ê¸´ê¸‰ ìˆ˜ì •ì— ì¥ê¸°ì  ê°œì„  ì œì•ˆ
            âŒ PR ë²”ìœ„ë¥¼ ë²—ì–´ë‚œ "ê¹€ì—" ì œì•ˆ
            âŒ ì´ë¯¸ ì‘ë™í•˜ëŠ” ì½”ë“œì˜ ì„ í˜¸ë„ ì°¨ì´
            </focus-breakers-to-avoid>
            </step-4-inline-comments>

            <step-5-summary-feedback>

            <github-comment-update>
            ë‹¤ìŒ êµ¬ì¡°ë¡œ ì—…ë°ì´íŠ¸:

            ```markdown
            ğŸ¤– **Claude Code Review ì™„ë£Œ**

            ## ğŸ“Œ PR ì´í•´
            [PR ëª©ì ê³¼ ì˜ë„ë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½]

            ## âœ… ë¦¬ë·° ê²°ê³¼

            ### ğŸ”´ í•„ìˆ˜ ìˆ˜ì •ì‚¬í•­ (ë°°í¬ ì „ ë°˜ë“œì‹œ)
            [ì •ë§ í¬ë¦¬í‹°ì»¬í•œ ì´ìŠˆë§Œ. ì—†ìœ¼ë©´ "ì—†ìŒ" í‘œì‹œ]

            ### ğŸŸ¡ ê¶Œì¥ ê°œì„ ì‚¬í•­ (ì„ íƒì )
            [ìˆìœ¼ë©´ ì¢‹ì€ ê°œì„ ì ë“¤]

            ### ğŸ’š ì˜í•œ ì 
            [ê¸ì •ì ì¸ í¬ì¸íŠ¸ê°€ ìˆë‹¤ë©´]

            ## ğŸ¯ ê²°ë¡ 
            [approve/request-changes ê²°ì •ê³¼ ì´ìœ ]
            ```
            </github-comment-update>
            </step-5-summary-feedback>

            <absolute-dont-do>
            <no-repetition>
            - ì´ì „ PRì—ì„œ ê±°ì ˆ/ë¬´ì‹œëœ ì œì•ˆ ë°˜ë³µ
            - ì‚¬ìš©ìê°€ ì˜ë„ì ìœ¼ë¡œ ì„ íƒí•œ íŒ¨í„´ ë¹„íŒ
            - AGENTS.mdì— ëª…ì‹œëœ "ì•Œë ¤ì§„ ê¸°ìˆ  ë¶€ì±„" ì–¸ê¸‰
            </no-repetition>

            <stay-in-scope>
            - PR ëª©ì ê³¼ ê´€ê³„ì—†ëŠ” "ê¹€ì—" ì œì•ˆ
            - 3ê°œ ì´ìƒ íŒŒì¼ ìˆ˜ì • í•„ìš”í•œ ëŒ€ê·œëª¨ ë³€ê²½
            - ì•„í‚¤í…ì²˜ ë ˆë²¨ ë¦¬íŒ©í† ë§ ì œì•ˆ
            </stay-in-scope>

            <watch-your-tone>
            - ê°€ë¥´ì¹˜ë ¤ëŠ” íƒœë„ ("ì´ë ‡ê²Œ í•˜ëŠ” ê²Œ ë§ì•„ìš”")
            - ì™„ë²½ì£¼ì˜ì  ìš”êµ¬ ("ëª¨ë“  ê³³ì— ì ìš©í•´ì•¼...")
            - ë¹„í˜„ì‹¤ì  ì œì•ˆ ("ì „ì²´ë¥¼ ë‹¤ì‹œ ì‘ì„±í•˜ë©´...")
            </watch-your-tone>
            </absolute-dont-do>

            <project-specific-context>
            AGENTS.mdì˜ "í”„ë¡œì íŠ¸ë³„ íŠ¹ìˆ˜ ì»¨í…ìŠ¤íŠ¸" ì„¹ì…˜ì„ ë°˜ë“œì‹œ ì°¸ì¡°í•˜ì—¬
            í”„ë¡œì íŠ¸ë³„ íŠ¹ìˆ˜ì‚¬í•­ê³¼ ì•Œë ¤ì§„ ê¸°ìˆ  ë¶€ì±„ë¥¼ ì´í•´í•˜ê³  ë¦¬ë·°í•˜ì„¸ìš”.
            </project-specific-context>

            ê±´ì„¤ì ì´ê³  ì‹¤ìš©ì ì¸ ë¦¬ë·°ë¡œ í”„ë¡œì íŠ¸ ë°œì „ì— ê¸°ì—¬í•´ì£¼ì„¸ìš”.
            </thoughtful-pr-review>

            To see the diff that needs to be reviewed, you must run this exact command. Note that the PR branch is already checked out in the current working directory.

            git diff $(git merge-base ${{ steps.pr.outputs.base_ref }} HEAD) -- . \
            ':(exclude)**/package.json' \
            ':(exclude)**/archive/**/*' \
            ':(exclude)**/.next/**/*' \
            ':(exclude)**/__testfixtures__/**/*' \
            ':(exclude)**/__generated__/**/*' \
            ':(exclude)**/__registry__/**/*' \
            ':(exclude)**/public/**/*' \
            ':(exclude)packages/css/**/*' \
            ':(exclude)**/schema.json' \
            ':(exclude)packages/qvism-preset/src/vars/**/*' \
            ':(exclude)packages/qvism-preset/src/token.css' \
            ':(exclude)packages/qvism-preset/src/tokens.ts' \
            ':(exclude)packages/tailwind3-plugin/src/index.ts' \
            ':(exclude)packages/tailwind4-theme/src/index.css'

            Use `gh pr comment` for *concise* top-level feedback.
            Use `mcp__github_inline_comment__create_inline_comment` to highlight specific code issues.
            Only post GitHub comments - don't submit review text as messages.
          claude_args: |
            --model claude-sonnet-4-5-20250929
            --allowedTools "
              Bash(cat *),
              Bash(find *),
              Bash(gh pr:*),
              Bash(git blame *),
              Bash(git diff *),
              Bash(git log *),
              Bash(git show *),
              Bash(git status),
              Bash(grep:*),
              Bash(head *),
              Bash(ls *),
              Bash(npm run *),
              Bash(python -c *),
              Bash(python -m pytest *),
              Bash(python -m ruff *),
              Bash(tail *),
              Bash(tree *),
              Bash(uv *),
              Edit,
              Glob,
              Grep,
              mcp__github__add_comment_to_pending_review,
              mcp__github__create_and_submit_pull_request_review,
              mcp__github__create_pending_pull_request_review,
              mcp__github__create_pull_request_review,
              mcp__github__create_review_comment,
              mcp__github__delete_pending_pull_request_review,
              mcp__github__get_file_contents,
              mcp__github__get_issue_comments,
              mcp__github__get_me,
              mcp__github__get_pull_request_comments,
              mcp__github__get_pull_request_diff,
              mcp__github__get_pull_request_files,
              mcp__github__get_pull_request_reviews,
              mcp__github__get_pull_request,
              mcp__github__get_repository,
              mcp__github__list_pull_requests,
              mcp__github__submit_pending_pull_request_review,
              mcp__github_ci__download_job_log,
              mcp__github_ci__get_ci_status,
              mcp__github_ci__get_workflow_run_details,
              mcp__github_comment__update_claude_comment,
              mcp__github_inline_comment__create_inline_comment,
              Read,
              Write
            "

      - name: Add success reaction
        if: success()
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'hooray'
            });

      - name: Add failure reaction
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: '-1'
            });
